<?php
/**
 * @var \Elsherif\Bosta\Block\Adminhtml\Order\View\Tab\Bosta $block
 * @var \Magento\Framework\Escaper $escaper
 */

// Only show if order uses Bosta shipping
if (!$block->canShow()) {
    return;
}

$delivery = $block->getDelivery();
$order = $block->getOrder();
?>

<div class="admin__page-section-item order-bosta-info" id="bosta-delivery-section">
    <div class="admin__page-section-title">
        <span class="title"><?= $escaper->escapeHtml(__('Bosta Delivery')) ?></span>
    </div>
    <?php if ($delivery && $delivery->getId()): ?>
        <div class="admin__page-section-item-title">
            <span class="title"><?= $escaper->escapeHtml(__('Bosta Delivery Information')) ?></span>
            <div class="actions" style="float: right;">
                <button type="button"
                        class="action-default scalable bosta-print-awb-btn"
                        onclick="printBostaAirwaybill(<?= (int)$delivery->getId() ?>)"
                        id="print-awb-btn"
                        title="<?= $escaper->escapeHtmlAttr(__('Print Airwaybill')) ?>">
                    <span><?= $escaper->escapeHtml(__('Print Airwaybill')) ?></span>
                </button>
                <button type="button"
                        class="action-default scalable"
                        onclick="refreshBostaTracking(<?= (int)$delivery->getId() ?>)"
                        id="refresh-tracking-btn"
                        title="<?= $escaper->escapeHtmlAttr(__('Refresh tracking information from Bosta')) ?>">
                    <span><?= $escaper->escapeHtml(__('Refresh Tracking')) ?></span>
                </button>
            </div>
        </div>
        <div class="admin__page-section-item-content">
            <table class="admin__table-secondary order-bosta-table">
                <tbody>
                <tr>
                    <th><?= $escaper->escapeHtml(__('Tracking Number')) ?></th>
                    <td>
                        <strong><?= $escaper->escapeHtml($delivery->getTrackingNumber()) ?></strong>
                        <a href="<?= $escaper->escapeUrl($block->getBostaTrackingUrl($delivery->getTrackingNumber())) ?>"
                           target="_blank"
                           title="<?= $escaper->escapeHtmlAttr(__('Track on Bosta')) ?>">
                            <?= $escaper->escapeHtml(__('Track on Bosta')) ?> â†—
                        </a>
                    </td>
                </tr>
                <tr>
                    <th><?= $escaper->escapeHtml(__('Bosta Delivery ID')) ?></th>
                    <td><?= $escaper->escapeHtml($delivery->getBostaDeliveryId()) ?></td>
                </tr>
                <tr>
                    <th><?= $escaper->escapeHtml(__('Current Status')) ?></th>
                    <td>
                            <span
                                class="bosta-status bosta-status-<?= $escaper->escapeHtmlAttr(strtolower($delivery->getStatus())) ?>">
                                <?= $escaper->escapeHtml($block->formatStatus($delivery->getStatus())) ?>
                            </span>
                    </td>
                </tr>
                <tr>
                    <th><?= $escaper->escapeHtml(__('Delivery Type')) ?></th>
                    <td>
                        <?= $delivery->getDeliveryType() == 20
                            ? $escaper->escapeHtml(__('Cash on Delivery (COD)'))
                            : $escaper->escapeHtml(__('Prepaid Package')) ?>
                    </td>
                </tr>
                <?php if ($delivery->getCodAmount()): ?>
                    <tr>
                        <th><?= $escaper->escapeHtml(__('COD Amount')) ?></th>
                        <td><?= $escaper->escapeHtml($order->formatPrice($delivery->getCodAmount())) ?></td>
                    </tr>
                <?php endif; ?>
                <tr>
                    <th><?= $escaper->escapeHtml(__('Shipping Cost')) ?></th>
                    <!--                    <td>-->
                    <?php //= $escaper->escapeHtml($order->formatPrice($delivery->getShippingCost())) ?><!--</td>-->
                    <td><?= /* @noEscape */
                        $order->formatPrice($delivery->getShippingCost()) ?></td>
                </tr>
                <tr>
                    <th><?= $escaper->escapeHtml(__('Created At')) ?></th>
                    <td><?= $escaper->escapeHtml($block->formatDate($delivery->getCreatedAt(), \IntlDateFormatter::MEDIUM, true)) ?></td>
                </tr>
                </tbody>
            </table>

            <script>
                require(['jquery', 'Magento_Ui/js/modal/alert'], function ($, alert) {
                    // Print Airwaybill Function - Generate AWB PDF from Bosta API
                    window.printBostaAirwaybill = function (deliveryId) {
                        // Open AWB generation URL in new window
                        var awbUrl = '<?= $escaper->escapeUrl($block->getUrl('bosta/delivery/printAwb', ['delivery_id' => $delivery->getId()])) ?>';
                        window.open(awbUrl, '_blank');
                    };

                    // Refresh Tracking Function
                    window.refreshBostaTracking = function (deliveryId) {
                        var btn = $('#refresh-tracking-btn');
                        btn.prop('disabled', true).find('span').text('<?= $escaper->escapeJs(__('Refreshing...')) ?>');

                        $.ajax({
                            url: '<?= $escaper->escapeUrl($block->getUrl('bosta/delivery/refresh')) ?>',
                            type: 'POST',
                            data: {
                                delivery_id: deliveryId,
                                form_key: '<?= $escaper->escapeJs($block->getFormKey()) ?>'
                            },
                            dataType: 'json',
                            success: function (response) {
                                if (response.success) {
                                    alert({
                                        title: '<?= $escaper->escapeJs(__('Success')) ?>',
                                        content: response.message || '<?= $escaper->escapeJs(__('Tracking information updated!')) ?>',
                                        actions: {
                                            always: function () {
                                                location.reload();
                                            }
                                        }
                                    });
                                } else {
                                    alert({
                                        title: '<?= $escaper->escapeJs(__('Error')) ?>',
                                        content: response.message || '<?= $escaper->escapeJs(__('Failed to refresh tracking.')) ?>'
                                    });
                                    btn.prop('disabled', false).find('span').text('<?= $escaper->escapeJs(__('Refresh Tracking')) ?>');
                                }
                            },
                            error: function () {
                                alert({
                                    title: '<?= $escaper->escapeJs(__('Error')) ?>',
                                    content: '<?= $escaper->escapeJs(__('An error occurred while refreshing tracking.')) ?>'
                                });
                                btn.prop('disabled', false).find('span').text('<?= $escaper->escapeJs(__('Refresh Tracking')) ?>');
                            }
                        });
                    };
                });
            </script>

            <?php if ($delivery->getAwbUrl()): ?>
                <div class="bosta-awb-section" style="margin-top: 20px;">
                    <a href="<?= $escaper->escapeUrl($delivery->getAwbUrl()) ?>"
                       target="_blank"
                       class="action-default scalable primary"
                       style="display: inline-block;">
                        <span><?= $escaper->escapeHtml(__('Print Shipping Label (AWB)')) ?></span>
                    </a>
                    <button type="button"
                            class="action-default scalable"
                            onclick="window.open('<?= $escaper->escapeUrl($delivery->getAwbUrl()) ?>', '_blank', 'width=800,height=600')"
                            style="display: inline-block; margin-left: 10px;">
                        <span><?= $escaper->escapeHtml(__('Open in Print Dialog')) ?></span>
                    </button>
                    <button type="button"
                            class="action-default scalable"
                            id="toggle-awb-preview"
                            style="display: inline-block; margin-left: 10px;">
                        <span><?= $escaper->escapeHtml(__('Show/Hide Preview')) ?></span>
                    </button>
                </div>

                <!-- AWB Preview Section -->
                <div id="awb-preview-container" style="margin-top: 20px; display: none;">
                    <div class="admin__page-section-item-title">
                        <span class="title"><?= $escaper->escapeHtml(__('Shipping Label Preview')) ?></span>
                    </div>
                    <div class="awb-preview-wrapper"
                         style="border: 2px solid #e0e0e0; border-radius: 5px; overflow: hidden; background: #fff;">
                        <iframe
                            src="<?= $escaper->escapeUrl($delivery->getAwbUrl()) ?>"
                            width="100%"
                            height="600px"
                            frameborder="0"
                            style="display: block;">
                        </iframe>
                    </div>
                </div>

                <script>
                    require(['jquery'], function ($) {
                        $('#toggle-awb-preview').on('click', function () {
                            $('#awb-preview-container').slideToggle(300);
                            console.log('Toggle AWB preview');
                        });
                    });
                </script>
            <?php endif; ?>

            <!-- Tracking Events -->
            <?php $trackingEvents = $block->getTrackingEvents(); ?>
            <?php if ($trackingEvents && count($trackingEvents)): ?>
                <div class="bosta-tracking-events" style="margin-top: 30px;">
                    <div class="admin__page-section-item-title">
                        <span class="title"><?= $escaper->escapeHtml(__('Tracking History')) ?></span>
                    </div>
                    <table class="admin__table-secondary">
                        <thead>
                        <tr>
                            <th><?= $escaper->escapeHtml(__('Date & Time')) ?></th>
                            <th><?= $escaper->escapeHtml(__('Status')) ?></th>
                            <th><?= $escaper->escapeHtml(__('Description')) ?></th>
                            <th><?= $escaper->escapeHtml(__('Location')) ?></th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($trackingEvents as $event): ?>
                            <tr>
                                <td><?= $escaper->escapeHtml($block->formatDate($event->getEventTimestamp(), \IntlDateFormatter::MEDIUM, true)) ?></td>
                                <td>
                                <span class="bosta-status-badge">
                                    <?= $escaper->escapeHtml($block->formatStatus($event->getStatus())) ?>
                                </span>
                                </td>
                                <td><?= $escaper->escapeHtml($event->getDescription() ?: '-') ?></td>
                                <td><?= $escaper->escapeHtml($event->getLocation() ?: '-') ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php endif; ?>
        </div>

        <style>
            /* Prominent Print Airwaybill Button - Bosta Brand Color */
            .bosta-print-awb-btn {
                background: linear-gradient(135deg, #2ec4b6 0%, #1ca89b 100%) !important;
                border: none !important;
                color: #fff !important;
                font-weight: 600 !important;
                padding: 8px 20px !important;
                font-size: 14px !important;
                box-shadow: 0 2px 4px rgba(46, 196, 182, 0.3) !important;
                transition: all 0.3s ease !important;
                margin-right: 10px !important;
            }

            .bosta-print-awb-btn:hover {
                background: linear-gradient(135deg, #1ca89b 0%, #168a7f 100%) !important;
                box-shadow: 0 4px 8px rgba(46, 196, 182, 0.4) !important;
                transform: translateY(-1px);
            }

            .bosta-print-awb-btn:active {
                transform: translateY(0);
                box-shadow: 0 2px 3px rgba(46, 196, 182, 0.3) !important;
            }

            .bosta-print-awb-btn span {
                color: #fff !important;
            }

            .bosta-status {
                padding: 5px 10px;
                border-radius: 3px;
                font-weight: bold;
                display: inline-block;
            }

            .bosta-status-pending {
                background: #ffeaa7;
                color: #2d3436;
            }

            .bosta-status-in_transit {
                background: #74b9ff;
                color: #2d3436;
            }

            .bosta-status-out_for_delivery {
                background: #a29bfe;
                color: #fff;
            }

            .bosta-status-delivered {
                background: #00b894;
                color: #fff;
            }

            .bosta-status-cancelled {
                background: #d63031;
                color: #fff;
            }

            .bosta-status-terminated {
                background: #d63031;
                color: #fff;
            }

            .bosta-status-badge {
                padding: 3px 8px;
                border-radius: 3px;
                background: #e0e0e0;
                font-size: 12px;
            }

            .order-bosta-table th {
                font-weight: 600;
                width: 200px;
            }
        </style>

    <?php else: ?>
        <div class="message message-notice">
            <p><?= $escaper->escapeHtml(__('No Bosta delivery found for this order.')) ?></p>
            <p><?= $escaper->escapeHtml(__('The delivery will be created automatically after the order is placed with Bosta shipping method.')) ?></p>
            <?php if ($order->getShippingMethod() && strpos($order->getShippingMethod(), 'customshipping') !== false): ?>
                <button type="button"
                        class="action-default scalable primary"
                        onclick="createBostaDelivery(<?= (int)$order->getId() ?>)"
                        id="create-bosta-delivery-btn"
                        style="margin-top: 15px;">
                    <span><?= $escaper->escapeHtml(__('Create Bosta Delivery Now')) ?></span>
                </button>
                <script>
                    require(['jquery', 'Magento_Ui/js/modal/alert'], function ($, alert) {
                        window.createBostaDelivery = function (orderId) {
                            var btn = $('#create-bosta-delivery-btn');
                            btn.prop('disabled', true).find('span').text('<?= $escaper->escapeJs(__('Creating...')) ?>');

                            $.ajax({
                                url: '<?= $escaper->escapeUrl($block->getUrl('bosta/delivery/create')) ?>',
                                type: 'POST',
                                data: {
                                    order_id: orderId,
                                    form_key: '<?= $escaper->escapeJs($block->getFormKey()) ?>'
                                },
                                dataType: 'json',
                                success: function (response) {
                                    if (response.success) {
                                        alert({
                                            title: '<?= $escaper->escapeJs(__('Success')) ?>',
                                            content: response.message || '<?= $escaper->escapeJs(__('Delivery created successfully!')) ?>',
                                            actions: {
                                                always: function () {
                                                    location.reload();
                                                }
                                            }
                                        });
                                    } else {
                                        alert({
                                            title: '<?= $escaper->escapeJs(__('Error')) ?>',
                                            content: response.message || '<?= $escaper->escapeJs(__('Failed to create delivery.')) ?>'
                                        });
                                        btn.prop('disabled', false).find('span').text('<?= $escaper->escapeJs(__('Create Bosta Delivery Now')) ?>');
                                    }
                                },
                                error: function () {
                                    alert({
                                        title: '<?= $escaper->escapeJs(__('Error')) ?>',
                                        content: '<?= $escaper->escapeJs(__('An error occurred while creating the delivery.')) ?>'
                                    });
                                    btn.prop('disabled', false).find('span').text('<?= $escaper->escapeJs(__('Create Bosta Delivery Now')) ?>');
                                }
                            });
                        };
                    });
                </script>
            <?php endif; ?>
        </div>
    <?php endif; ?>
</div>
